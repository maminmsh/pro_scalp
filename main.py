import asyncio
import pandas as pd
import get_data as gd
from app import pro_scalper_ai
from load_save_data import save_to_sqlite, load_from_sqlite

# ğŸ“Œ Ø§Ø¬Ø±Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§:
if __name__ == "__main__":
    # Ú¯Ø±ÙØªÙ† 1000 Ú©Ù†Ø¯Ù„ ÛŒÚ©â€ŒØ¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ Ø¢Ø®Ø±
    candles = gd.get_historical_ohlcv(limit=1000)
    print("Ù†Ù…ÙˆÙ†Ù‡ Ú©Ù†Ø¯Ù„:", candles[-1])  # Ø¢Ø®Ø±ÛŒÙ† Ú©Ù†Ø¯Ù„

    # Ú¯Ø±ÙØªÙ† Ú©Ù†Ø¯Ù„ Ø§Ø² Ø¨Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ®ÛŒ Ù…Ø´Ø®Øµ
    candles_range = gd.get_historical_ohlcv(since="2024-07-01T00:00:00Z", to="2024-07-02T00:00:00Z")
    print(f"{len(candles_range)} Ú©Ù†Ø¯Ù„ Ø§Ø² Ø¨Ø§Ø²Ù‡ Ù…Ø´Ø®Øµ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯")

    # ØªØ¨Ø¯ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ù‡ DataFrame
    df = pd.DataFrame(candles, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])

    # Ø­Ø°Ù Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ ØºÛŒØ±Ø¶Ø±ÙˆØ±ÛŒ (Ù…Ø«Ù„ timestamp) Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†Ø¯
    df = df[['timestamp','open', 'high', 'low', 'close', 'volume']]

    # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ù†ÙˆØ¹ Ø¹Ø¯Ø¯ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
    df = df.astype({
        'open': float,
        'high': float,
        'low': float,
        'close': float,
        'volume': float
    })

    # Ø§Ø¬Ø±Ø§ÛŒ ØªØ§Ø¨Ø¹ pro_scalper_ai Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ
    results = pro_scalper_ai(df)
    print("Ù†ØªØ§ÛŒØ¬ Pro Scalper AI:")
    print(results.tail())

    # Strong Buy
    # Strong Sell
    # Early Buy
    # Early Sell
    # No Signal

    # Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ Ø¯Ø± SQLite
    save_to_sqlite(results, db_name="trading_data.db", table_name="signals")

    # Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ
    loaded_df = load_from_sqlite(db_name="trading_data.db", table_name="signals")
    print("Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒâ€ŒØ´Ø¯Ù‡ Ø§Ø² SQLite:")
    print(loaded_df.tail())

    # Ø§Ø¬Ø±Ø§ÛŒ WebSocket Ø¨Ù‡ ØµÙˆØ±Øª async (Ù‡Ù…ÛŒØ´Ù‡ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ ÙØ§ÛŒÙ„)
    asyncio.run(gd.watch_ticker())